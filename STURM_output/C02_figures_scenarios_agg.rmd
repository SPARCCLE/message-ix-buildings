---
output: reprex::reprex_document
knit: reprex::reprex_render
---

Notebook to run STURM Ouput.

```{r}
library(dplyr)
library(ggplot2)
library(stringr)

print(paste("Working directory is:", getwd()))

# Loding figures setttings and functions
source("STURM_output/C00_plots.R")

# run <- "scenarios_EU_policies"
run <- "scenarios_test_policies"
scenarios <- c(
  "EU_exogenous" = "Current renovation rate",
  "EU_no_exogenous" = "No renovation",
  # "EU_double_exogenous" = "Double renovation rate",
  "EU_triple_exogenous" = "Triple renovation rate"
  # "EU_medium_heat" = "Medium additional policies heat-pumps",
  # "EU_medium_shell" = "Medium additional policies renovation"
  )

run <- "scenarios_test_prices"
scenarios <- c(
  "EU" = "Current policies",
  "EU_price_high" = "High price",
  "EU_price_constant" = "Price constant"
)

run <- "scenarios_test_emission"
scenarios <- c(
  "EU" = "NPi",
  "EU_emission_2020_400" = "NPi 2020_400",
  "EU_emission_constant" = "Emisison constant"
)


run <- "test"
scenarios <- c(
  "EU_exogenous" = "Current renovation rate",
  "EU_no_exogenous" = "No renovation",
  "EU_double_exogenous" = "Double renovation rate",
  "EU_triple_exogenous" = "Triple renovation rate"
)
```

## Read data
```{r}
data <- data.frame(NULL)

for (scenario in names(scenarios)) {
  print(paste("Scenario:", scenario))
  file <- paste0("report_agg_STURM_", scenario, "_resid_region_bld_energy.csv")
  file <- paste("STURM_output/results", file, sep = "/")

  if (!file.exists(file)) {
    print("Check file name or directory!")
  }

  save_dir <- paste("STURM_output", "figures", sep = "/")
  print(dir.exists(save_dir))

  # Read output files
  temp <- read.csv(file) %>%
    mutate(scenario = scenario)

  
  data <- bind_rows(data, temp)
}
# Reconstuction flows
flows <- c("cost_renovation_EUR", "n_renovation")
stp <- 5
data <- data %>%
  mutate(year = ifelse(variable %in% flows, year - stp, year),
         value = ifelse(variable %in% flows, value / stp, value))
```

## Figures

### Absolute values
```{r}
source("STURM_output/C00_plots.R")

temp <- data %>%
  filter(variable == "heat_kWh") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e9)

plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Consumtion\nTWh",
    free_y = TRUE,
    save_path = paste(save_dir,
      paste0(run, "_heat_kWh_countries.png"), sep = "/"))


temp <- data %>%
  filter(variable == "heat_tCO2") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e6)

plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Emission\nMtCO2",
    free_y = TRUE,
    save_path = paste(save_dir,
      paste0(run, "_heat_tCO2_countries.png"), sep = "/"))

temp <- data %>%
  filter(variable == "n_renovation") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e3)

plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Renovation\nThousands",
    free_y = TRUE,
    save_path = paste(save_dir,
      paste0(run, "_renovation_countries.png"), sep = "/"))
```
```{r}
temp <- data %>%
  filter(variable == "stock_building") %>%
  filter(resolution %in% "heat_pump") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e6)

plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Stock Heat-pumps\nMillion",
    free_y = TRUE,
    save_path = paste(save_dir,
      paste0(run, "_heat_pumps_countries.png"), sep = "/"))
```

### Indicators comparison

#### Unit consumption
```{r}
var <- "heat_kWh"
ref <- "floor_m2"
path <- "_kwh_m2_countries.png"
y_label <- "Space heating consumption\nkWh per square meter"

temp <- data %>%
  filter(variable %in% c(var, ref)) %>%
  filter(resolution == "all") %>%
  pivot_wider(id_cols = c(region_bld, year, scenario, resolution),
    names_from = variable,
    values_from = value) %>%
  filter(!is.na(.data[[var]])) %>%
  filter(!is.na(.data[[ref]])) %>%
  mutate(value = .data[[var]] / .data[[ref]]) %>%
  select(-c(var, ref, "resolution"))


plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = y_label,
    free_y = TRUE,
    save_path = paste(save_dir,
      paste0(run, path), sep = "/"))
```

#### Renovation rate

```{r}
var <- "n_renovation"
ref <- "stock_building"
path <- "_renovation_rate_countries.png"
y_label <- "Renovation rate"

temp <- data %>%
  filter(variable %in% c(var, ref)) %>%
  filter(resolution == "all") %>%
  pivot_wider(id_cols = c(region_bld, year, scenario, resolution),
    names_from = variable,
    values_from = value) %>%
  filter(!is.na(.data[[var]])) %>%
  filter(!is.na(.data[[ref]])) %>%
  mutate(value = .data[[var]] / .data[[ref]]) %>%
  select(-c(var, ref, "resolution"))


plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = y_label,
    free_y = FALSE,
    save_path = paste(save_dir,
      paste0(run, path), sep = "/"))
```

#### Energy poverty

```{r}
var <- "energy_poverty_median"
ref <- "stock_building"
path <- "_energy_poverty_median_countries.png"
y_label <- "Energy poverty rate with median definition"

temp <- data %>%
  filter(variable %in% c(var, ref)) %>%
  filter(resolution == "all") %>%
  pivot_wider(id_cols = c(region_bld, year, scenario, resolution),
    names_from = variable,
    values_from = value) %>%
  filter(!is.na(.data[[var]])) %>%
  filter(!is.na(.data[[ref]])) %>%
  mutate(value = .data[[var]] / .data[[ref]]) %>%
  select(-c(var, ref, "resolution"))


plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = y_label,
    free_y = FALSE,
    save_path = paste(save_dir,
      paste0(run, path), sep = "/"))

```

```{r}
var <- "energy_poverty_thres"
ref <- "stock_building"
path <- "_energy_poverty_threshold_countries.png"
y_label <- "Energy poverty rate with threshold definition"

temp <- data %>%
  filter(variable %in% c(var, ref)) %>%
  filter(resolution == "all") %>%
  pivot_wider(id_cols = c(region_bld, year, scenario, resolution),
    names_from = variable,
    values_from = value) %>%
  filter(!is.na(.data[[var]])) %>%
  filter(!is.na(.data[[ref]])) %>%
  mutate(value = .data[[var]] / .data[[ref]]) %>%
  select(-c(var, ref, "resolution"))


plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = y_label,
    free_y = FALSE,
    save_path = paste(save_dir,
      paste0(run, path), sep = "/"))

```