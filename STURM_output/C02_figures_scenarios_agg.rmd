---
output: reprex::reprex_document
knit: reprex::reprex_render
---

Notebook to run STURM Ouput.

```{r}
library(dplyr)
library(ggplot2)
library(stringr)
library(tidyr)

print(paste("Working directory is:", getwd()))

# Loding figures setttings and functions
source("STURM_output/C00_plots.R")


run_test <- FALSE
if (run_test) {
      run <- "scenarios_test"
      scenarios <- c(
        "EU_exogenous" = "Baseline",
        "EU_constant_exogenous" = "Price constant",
        "EU_price_2020_600_exogenous" = "Carbon tax",
        "EU_no_exogenous" = "No renovation",
        "EU_no_constant_exogenous" = "No renovation, Price constant",
        "EU_double_exogenous" = "Doubling renovation",
        "EU_double_constant_exogenous" =
          "Doubling renovation, Price constant",
        "EU_triple_exogenous" = "Tripling renovation",
        "EU_triple_constant_exogenous" =
          "Tripling renovation, Price constant",
        "EU_emission_1p5c_exogenous" = "Low emission factor",
        "EU_double_emission_1p5c_exogenous" =
          "Doubling renovation, Low emission factor",
        "EU_1p5c_exogenous" = "1p5C"
    ) 
  
      scenarios <- c(
        "EU_no_exogenous" = "No renovation",
        "EU_exogenous" = "Baseline",
        "EU_double_exogenous" = "Doubling renovation",
        "EU_double_emission_1p5c_exogenous" = "Doubling renovation, 1p5c")

      colors_scenarios <- c(
        "Price constant" = "#247f6e",
        "Doubling renovation" = "#ee6a6b",
        "Doubling renovation, Price constant" = "#531717",
        "Doubling renovation, 1p5c" = "#1f540b",
        "Tripling renovation" = "#380707",
        "Tripling renovation, Price constant" = "#531717",
        "No renovation" = "#6a4c93",
        "No renovation, Price constant" = "#531717"
      )
    } else {
    run <- "scenarios_policies"
    scenarios <- c(
      "EU" = "Current policies",
      "EU_carbon_tax" = "Carbon tax",
      "EU_carbon_tax_ambitious" = "Carbon tax ambitious",
      "EU_incentives_policies" = "Carbon tax, Incentives",
      # "EU_incentives_policies_advanced" = "Carbon tax, Incentives adv.",
      # "EU_incentives_policies_income" = "Carbon tax, Incentives inc.",
      # "EU_incentives_policies_advanced_income" = "Carbon tax, Incentives adv. and inc.",
      "EU_mix_policies" = "Carbon tax, Incentives, Regulation",
      "EU_mix_policies_1p5C" = "Low emission"
    )
    scenarios <- c(
      "EU" = "Current policies",
      "EU_carbon_tax" = "Carbon tax",
      "EU_carbon_tax_ambitious" = "Carbon tax ambitious",
      "EU_incentives_policies" = "Carbon tax, Incentives",
      "EU_incentives_policies_advanced" = "Carbon tax, Incentives adv.",
      "EU_incentives_policies_income" = "Carbon tax, Incentives inc.",
      "EU_incentives_policies_advanced_income" = "Carbon tax, Incentives adv. and inc.",
      "EU_mix_policies" = "Carbon tax, Incentives, Regulation",
      "EU_mix_policies_1p5C" = "Low emission"
    )
    scenarios <- c(
      "EU" = "Current policies",
      "EU_incentives_policies" = "Carbon tax, Incentives"
    )
  }

colors_scenarios <- c(
  "Baseline" = "#00589d",
  "Current policies" = "#00589d",
  "Carbon tax" = "#fdbb40",
  "Carbon tax ambitious" = "#b17c1a",
  "Carbon tax, Incentives" = "#ee6a6b",
  "Carbon tax, Incentives adv." = "#764444",
  "Carbon tax, Incentives inc." = "#531717",
  "Carbon tax, Incentives adv. and inc." = "#f41010",
  "Carbon tax, Incentives, Regulation" = "#62c5c0",
  "Low emission" = "#2a9d00",
  "Ambitious heat-pumps, price constant" = "#677473",
  "Subsidies renovation" = "#ee6a6b",
  "Ambitious renovation, prices constant" = "#531717",
  "1p5C" = "#fdbb40",
  "Subsidies 80 hp" = "#62c5c0",
  "Subsidies 50 hp" = "#677473"
  )

line_styles_scenarios <- c(
  "Baseline" = "solid",
  "Current policies" = "solid",
  "Carbon tax" = "dotted",
  "Carbon tax, Incentives" = "solid",
  "Carbon tax, Incentives, Regulation" = "dotdash"
)

```

## Read data
```{r}
save_dir <- paste("STURM_output", "figures", run, sep = "/")
if (!dir.exists(save_dir)) {
  dir.create(save_dir)
}

data <- data.frame(NULL)

for (scenario in names(scenarios)) {
  print(paste("Scenario:", scenario))
  file <- paste0("report_agg_STURM_", scenario, "_resid_region_bld_energy.csv")
  file <- paste("STURM_output/results", file, sep = "/")

  if (!file.exists(file)) {
    print("Check file name or directory!")
  }

  # Read output files
  temp <- read.csv(file) %>%
    mutate(scenario = scenario)
  
  data <- bind_rows(data, temp)
}
# Reconstuction flows
flows <- c("n_renovation", "cost_renovation_EUR", "sub_renovation_EUR",
  "n_replacement", "cost_heater_EUR", "sub_heater_EUR")

data <- data %>%
  mutate(scenario = scenarios[.data[["scenario"]]])

stp <- 5

data <- data %>%
 mutate(year = ifelse(variable %in% flows, year - stp, year),
        value = ifelse(variable %in% flows, value / stp, value))
data <- distinct(data)
```

## Figures
### Table summary
```{r}
ref <- "Baseline"
base_year <- 2015
end_year <- 2050

variables <- c("heat_kWh", "heat_std_kWh", "heat_tCO2",
     "energy_poverty_thres", "stock_building",
      "heating_intensity")

low_carbon <- c("biomass_solid", "heat_pump", "electricity", "district_heat")

# initial data from variables
ini <- data %>%
  filter(year == base_year) %>%
  filter(scenario == ref) %>%
  mutate(scenario = " Initial") %>%
  filter(resolution == "all") %>%
  filter(variable %in% variables) %>%
  select(-c("resolution", "year")) %>%
  pivot_wider(id_cols = c(region_bld, scenario),
    names_from = variable,
    values_from = value)

# final data from variables
table <- data %>%
  filter(year == end_year) %>%
  filter(resolution == "all") %>%
  filter(variable %in% variables) %>%
  select(-c("resolution", "year")) %>%
  pivot_wider(id_cols = c(region_bld, scenario),
    names_from = variable,
    values_from = value)

table <- bind_rows(ini, table)

# replacement heating system
temp <- data %>%
  filter(year <= end_year) %>%
  filter(resolution == "all") %>%
  filter(variable == "n_replacement") %>%
  group_by_at(c("region_bld", "scenario")) %>%
  summarize(replacement_heater = sum(value) * stp) %>%
  ungroup()
table <- left_join(table, temp, by = c("region_bld", "scenario")) %>%
  mutate(replacement_heater =
    ifelse(is.na(replacement_heater), 0, replacement_heater))

# cost renovation
temp <- data %>%
  filter(year <= end_year) %>%
  filter(resolution == "all") %>%
  filter(variable == "cost_renovation_EUR") %>%
  group_by_at(c("region_bld", "scenario")) %>%
  summarize(cost_renovation_EUR = sum(value) * stp) %>%
  ungroup()
table <- left_join(table, temp, by = c("region_bld", "scenario")) %>%
  mutate(cost_renovation_EUR =
    ifelse(is.na(cost_renovation_EUR), 0, cost_renovation_EUR))

# subsidies renovation
temp <- data %>%
  filter(year <= end_year) %>%
  filter(resolution == "all") %>%
  filter(variable == "sub_renovation_EUR") %>%
  group_by_at(c("region_bld", "scenario")) %>%
  summarize(sub_renovation_EUR = sum(value) * stp) %>%
  ungroup()
table <- left_join(table, temp, by = c("region_bld", "scenario")) %>%
  mutate(sub_renovation_EUR =
    ifelse(is.na(sub_renovation_EUR), 0, sub_renovation_EUR))

# cost heater
temp <- data %>%
  filter(year <= end_year) %>%
  filter(resolution == "all") %>%
  filter(variable == "cost_heater_EUR") %>%
  group_by_at(c("region_bld", "scenario")) %>%
  summarize(cost_heater_EUR = sum(value) * stp) %>%
  ungroup()
table <- left_join(table, temp, by = c("region_bld", "scenario")) %>%
  mutate(cost_heater_EUR =
    ifelse(is.na(cost_heater_EUR), 0, cost_heater_EUR))

# subsidies heater
temp <- data %>%
  filter(year <= end_year) %>%
  filter(resolution == "all") %>%
  filter(variable == "sub_heater_EUR") %>%
  group_by_at(c("region_bld", "scenario")) %>%
  summarize(sub_heater_EUR = sum(value) * stp) %>%
  ungroup()
table <- left_join(table, temp, by = c("region_bld", "scenario")) %>%
  mutate(sub_heater_EUR =
    ifelse(is.na(sub_heater_EUR), 0, sub_heater_EUR))

# renovated buildings
temp <- data %>%
  filter(variable == "stock_building") %>%
  filter(year == end_year) %>%
  filter(resolution %in% c("std", "adv")) %>%
  select(-c("resolution", "year")) %>%
  group_by_at(c("region_bld", "scenario")) %>%
  summarize(renovated_building = sum(value)) %>%
  ungroup()

table <- left_join(table, temp, by = c("region_bld", "scenario")) %>%
  mutate(renovated_building =
    ifelse(is.na(renovated_building), 0, renovated_building))

# advanced buildings
temp <- data %>%
  filter(variable == "stock_building") %>%
  filter(year == end_year) %>%
  filter(resolution == "adv") %>%
  select(-c("resolution", "year")) %>%
  group_by_at(c("region_bld", "scenario")) %>%
  summarize(advanced_renovated_building = sum(value)) %>%
  ungroup()

table <- left_join(table, temp, by = c("region_bld", "scenario")) %>%
  mutate(advanced_renovated_building =
    ifelse(is.na(advanced_renovated_building), 0, advanced_renovated_building))

# low-carbon buildings
temp <- data %>%
  filter(variable == "stock_building") %>%
  filter(year == end_year) %>%
  filter(resolution %in% low_carbon) %>%
  group_by_at(c("region_bld", "scenario")) %>%
  summarize(low_carbon_building = sum(value)) %>%
  ungroup()

# initial data
ini <- data %>%
  filter(variable == "stock_building") %>%
  filter(year == base_year) %>%
  filter(scenario == ref) %>%
  filter(resolution %in% low_carbon) %>%
  group_by_at(c("region_bld", "scenario")) %>%
  summarize(low_carbon_building = sum(value)) %>%
  ungroup() %>%
  mutate(scenario = " Initial")
temp <- bind_rows(ini, temp)

table <- left_join(table, temp, by = c("region_bld", "scenario")) %>%
  mutate(renovated_building =
    ifelse(is.na(renovated_building), 0, renovated_building))

# formatting output
format_temp <- table %>%
  arrange(region_bld, scenario) %>%
  mutate(,
    heat_kWh = round(heat_kWh / 1e9, 2),
    heat_std_kWh = round(heat_std_kWh / 1e9, 2),
    heat_tCO2 = round(heat_tCO2 / 1e6, 2),
    stock_building = round(stock_building / 1e3, 2),
    heating_intensity = round(heating_intensity, 2),
    renovated_building = round(renovated_building / 1e3, 2),
    advanced_renovated_building =
      round(advanced_renovated_building / 1e3, 2),
    replacement_heater = round(replacement_heater / 1e3, 2),
    low_carbon_building = round(low_carbon_building / 1e3, 2),
    energy_poverty_thres =
      round(energy_poverty_thres / 1e3, 2),
    cost_renovation_EUR = round(cost_renovation_EUR / 1e9, 2),
    sub_renovation_EUR = round(sub_renovation_EUR / 1e9, 2),
    cost_heater_EUR = round(cost_heater_EUR / 1e9, 2),
    sub_heater_EUR = round(sub_heater_EUR / 1e9, 2)
      ) %>%
  mutate(region_bld = plot_settings[["rename"]][region_bld]) %>%
  select(c("region_bld", "scenario",
    "heat_kWh", "heat_std_kWh", "heat_tCO2",
    "heating_intensity", "stock_building", "low_carbon_building",
    "renovated_building", "advanced_renovated_building",
    "replacement_heater", "energy_poverty_thres",
    "cost_renovation_EUR", "sub_renovation_EUR",
    "cost_heater_EUR", "sub_heater_EUR")) %>%
  mutate(low_carbon_building_rate = low_carbon_building / stock_building,
    renovated_building_rate = renovated_building / stock_building,
    energy_poverty_rate = energy_poverty_thres / stock_building) %>%
  rename(
    "Energy poverty (Thousand)" = energy_poverty_thres,
    "Energy poverty (Percent)" = energy_poverty_rate,
    "Renovated buildings (Thousand)" = renovated_building,
    "Renovated buildings advanced (Thousand)" = advanced_renovated_building,
    "Renovated buildings (Percent)" = renovated_building_rate,
    "Low carbon buildings (Thousand)" = low_carbon_building,
    "Low carbon buildings (Percent)" = low_carbon_building_rate,
    "Stock building (Thousand)" = stock_building,
    "Replacement heating system (Thousand)" = replacement_heater,
    "Heating intensity (Percent)" = heating_intensity,
    "Space heating consumption (TWh)" = heat_kWh,
    "Space heating consumption standard (TWh)" = heat_std_kWh,
    "Emission (MtCO2)" = heat_tCO2,
    "Member states" = region_bld,
    "Scenario" = scenario,
    "Cost renovation (Billion EUR)" = cost_renovation_EUR,
    "Subsidies renovation (Billion EUR)" = sub_renovation_EUR,
    "Cost heater (Billion EUR)" = cost_heater_EUR,
    "Subsidies heater (Billion EUR)" = sub_heater_EUR
    )

write.csv(format_temp,
  paste(save_dir, paste0(run, "_", end_year, "_summary_countries.csv"), sep = "/"),
  row.names = FALSE)

format_temp_eu <- format_temp %>%
  filter(`Member states` == "EU") %>%
  select(-c("Member states"))
format_temp_eu <- as.data.frame(t(format_temp_eu))
colnames(format_temp_eu) <- format_temp_eu[1,]
format_temp_eu <- format_temp_eu[-1,]
write.csv(format_temp_eu,
  paste(save_dir, paste0(run, "_", end_year, "_summary_eu.csv"), sep = "/"))

```

### Figure summary

```{r}
source("STURM_output/C00_plots.R")

format_temp_eu <- format_temp %>%
  filter(`Member states` == "EU") %>%
  mutate(`Energy poverty (Percent)` = `Energy poverty (Percent)` * 100)

legend <- FALSE
presentation <- TRUE
scatter_plots(format_temp_eu,
              "Emission (MtCO2)",
              "Energy poverty (Percent)",
              color_column = "Scenario",
              colors_scenarios = colors_scenarios,
              size_column = "Low carbon buildings (Percent)",
              save_path = paste(save_dir, paste0(run, "_tCO2_poverty_eu.png"), sep = "/"),
              y_label_suffix = "%",
              x_label_suffix = "MtCO2",
              legend = legend,
              presentation = presentation
              )


```


### Figures

#### Space heating consumption
```{r}
temp <- data %>%
  filter(variable == "heat_kWh") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e9)

plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Residential space heating consumption in EU\nTWh",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_heat_kWh_countries.png"), sep = "/")
    )

legend <- FALSE
presentation <- TRUE
plot_multiple_lines(filter(temp, region_bld == "EU"),
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = NULL,
    ncol = 4,
    y_label = "Residential space heating consumption",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    line_types = line_styles_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_heat_kWh_eu.png"), sep = "/"),
    legend = legend,
    y_label_suffix = "TWh",
    presentation = presentation)
```

##### Electricity consumption
```{r}
temp <- data %>%
  filter(variable == "heat_kWh") %>%
  filter(resolution %in% c("heat_pump", "electricity")) %>%
  group_by_at(c("region_bld", "year", "scenario")) %>%
  summarize(value = sum(value)) %>%
  ungroup() %>%
  mutate(value = value / 1e9)

plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Residential space heating electricity consumption in EU\nTWh",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_heat_kWh_electricity_countries.png"), sep = "/"))

legend <- FALSE
presentation <- TRUE
plot_multiple_lines(filter(temp, region_bld == "EU"),
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = NULL,
    ncol = 4,
    y_label = "Residential space heating electricity consumption in EU\nTWh",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    line_types = line_styles_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_heat_kWh_electricity_eu.png"), sep = "/"),
    y_label_suffix = "TWh",
    legend = legend,
    presentation = presentation)
```

##### Standard
```{r}
temp <- data %>%
  filter(variable == "heat_std_kWh") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e9)

plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Consumtion standard\nTWh",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_heat_std_kWh_countries.png"), sep = "/"))

plot_multiple_lines(filter(temp, region_bld == "EU"),
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = NULL,
    ncol = 4,
    y_label = "Consumtion standard\nTWh",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    line_types = line_styles_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_heat_std_kWh_eu.png"), sep = "/"),
    suffix_y = "TWh")
```

##### Emission

```{r}
source("STURM_output/C00_plots.R")

temp <- data %>%
  filter(variable == "heat_tCO2") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e6)

plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Residential space heating emission Scope 2\nMtCO2",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_heat_tCO2_countries.png"), sep = "/"))

legend <- FALSE
presentation <- TRUE
plot_multiple_lines(filter(temp, region_bld == "EU"),
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = NULL,
    ncol = 4,
    y_label = "Residential space heating emission Scope 2",
    free_y = TRUE,
    line_types = line_styles_scenarios,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_heat_tCO2_eu.png"), sep = "/"),
    legend = legend,
    y_label_suffix = "MtCO2",
    presentation = presentation)

```

#### Number of renovations cumulated

```{r}

temp <- data %>%
  filter(variable == "n_renovation") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  group_by(scenario, region_bld) %>%
  arrange(year) %>%
  mutate(value = cumsum(value)) %>%
  ungroup() %>%
  mutate(value = value * 5 / 1e3)

plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Cumulated number of renovations\nThousand",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_renovation_cumulated_countries.png"), sep = "/"))

plot_multiple_lines(filter(temp, region_bld == "EU"),
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = NULL,
    ncol = 4,
    y_label = "Cumulated number of renovations\nThousand",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_renovation_cumulated_eu.png"), sep = "/"))
```

#### Number of renovations by income cumulated

```{r}
source("STURM_output/C00_plots.R")

temp <- data %>%
  filter(region_bld == "EU") %>%
  filter(variable == "n_renovation") %>%
  filter(resolution %in% c("q1", "q2", "q3")) %>%
  group_by(scenario, resolution) %>%
  arrange(year) %>%
  mutate(value = cumsum(value)) %>%
  ungroup() %>%
  mutate(value = value * 5 / 1e3) %>%
  select(-c("variable", "region_bld"))


plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "resolution",
    ncol = 3,
    y_label = "Cumulated number of renovations\nThousand",
    free_y = FALSE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_renovation_cumulated_income_eu.png"), sep = "/"))
```

#### Number of renovation
```{r}
temp <- data %>%
  filter(variable == "n_renovation") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e3)

plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Renovation\nThousands",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_renovation_countries.png"), sep = "/"))

plot_multiple_lines(filter(temp, region_bld == "EU"),
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = NULL,
    ncol = 4,
    y_label = "Renovation\nThousands",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_renovation_eu.png"), sep = "/"))
```
#### Number of heat-pumps
```{r}
temp <- data %>%
  filter(variable == "stock_building") %>%
  filter(resolution %in% "heat_pump") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e6)

plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Stock Heat-pumps\nMillion",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_heat_pumps_countries.png"), sep = "/"))

plot_multiple_lines(filter(temp, region_bld == "EU"),
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = NULL,
    ncol = 4,
    y_label = "Stock Heat-pumps\nMillion",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_heat_pumps_eu.png"), sep = "/"))
```

#### Number of renovation

```{r}
temp <- data %>%
  filter(variable == "n_renovation") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e3)

plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Renovation\nThousands",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_renovation_countries.png"), sep = "/"))
```

#### Cost of renovation

```{r}
temp <- data %>%
  filter(variable == "cost_renovation_EUR") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e9)

plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Cost Energy Renovation\nBillion EUR per year",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_cost_renovation_countries.png"), sep = "/"))

plot_multiple_lines(filter(temp, region_bld == "EU"),
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = NULL,
    ncol = 4,
    y_label = "Cost Energy Renovation\nBillion EUR per year",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_cost_renovation_eu.png"), sep = "/"))
```

#### Cost heating system

```{r}

temp <- data %>%
  filter(variable == "cost_heater_EUR") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e9)

plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Cost Heating system\nBillion EUR per year",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_cost_heater_countries.png"), sep = "/"))

plot_multiple_lines(filter(temp, region_bld == "EU"),
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = NULL,
    ncol = 4,
    y_label = "Cost Heating system\nBillion EUR per year",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_cost_heater_eu.png"), sep = "/"))
```
#### Cost heating 
```{r}
temp <- data %>%
  filter(variable == "cost_heat_EUR") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e9)

plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Cost Heating\nBillion EUR",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_cost_heat_countries.png"), sep = "/"))

plot_multiple_lines(filter(temp, region_bld == "EU"),
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = NULL,
    ncol = 4,
    y_label = "Cost Heating\nBillion EURn",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_cost_heat_eu.png"), sep = "/"))

```

### Indicators comparison

#### Unit consumption
```{r}
var <- "heat_kWh"
ref <- "floor_m2"
path <- "_kwh_m2_countries.png"
y_label <- "Space heating consumption\nkWh per square meter"

temp <- data %>%
  filter(variable %in% c(var, ref)) %>%
  filter(resolution == "all") %>%
  pivot_wider(id_cols = c(region_bld, year, scenario, resolution),
    names_from = variable,
    values_from = value) %>%
  filter(!is.na(.data[[var]])) %>%
  filter(!is.na(.data[[ref]])) %>%
  mutate(value = .data[[var]] / .data[[ref]]) %>%
  select(-c(var, ref, "resolution"))


plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = y_label,
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, path), sep = "/"))

path <- "_kwh_m2_eu.png"
temp <- filter(temp, region_bld == "EU")
plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = NULL,
    ncol = 4,
    y_label = y_label,
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, path), sep = "/"))
```
```{r}
source("STURM_output/C00_plots.R")

var <- "heat_kWh"
ref <- "stock_building"

temp <- data %>%
  filter(variable %in% c(var, ref)) %>%
  filter(resolution == "all") %>%
  pivot_wider(id_cols = c(region_bld, year, scenario, resolution),
    names_from = variable,
    values_from = value) %>%
  filter(!is.na(.data[[var]])) %>%
  filter(!is.na(.data[[ref]])) %>%
  mutate(value = .data[[var]] / .data[[ref]]) %>%
  select(-c(var, ref, "resolution"))


plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Space heating consumption\nkWh per dwelling",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_kwh_dw_countries.png"), sep = "/"))

path <- "_kwh_dw_eu.png"
temp <- filter(temp, region_bld == "EU")
plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = NULL,
    ncol = 4,
    y_label = "Space heating consumption\nkWh per dwelling",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_kwh_dw_eu.png"), sep = "/"),
    y_label_suffix = "kWh/dw")
```

#### Renovation rate

```{r}
var <- "n_renovation"
ref <- "stock_building"

# filter(temp, region_bld == "EU")

temp <- data %>%
  filter(variable %in% c(var, ref)) %>%
  filter(resolution == "all") %>%
  filter(region_bld == "EU") %>%
  pivot_wider(id_cols = c(region_bld, year, scenario, resolution),
    names_from = variable,
    values_from = value) %>%
  filter(!is.na(.data[[var]])) %>%
  filter(!is.na(.data[[ref]])) %>%
  mutate(value = .data[[var]] / .data[[ref]]) %>%
  select(-c(var, ref, "resolution"))


plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Renovation rate",
    free_y = FALSE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_renovation_rate_countries.png"), sep = "/"))

presentation <- FALSE
legend <- TRUE
path <- "_renovation_rate_eu.png"
temp <- filter(temp, region_bld == "EU")
plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = NULL,
    ncol = 4,
    y_label = "Renovation rate",
    free_y = FALSE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_renovation_rate_eu.png"), sep = "/"),
    presentation = presentation,
    legend = legend,
    y_label_suffix = "%")
```

#### Energy poverty

```{r}
var <- "energy_poverty_thres"
ref <- "stock_building"
temp <- data %>%
  filter(variable %in% c(var, ref)) %>%
  filter(resolution == "all") %>%
  pivot_wider(id_cols = c(region_bld, year, scenario, resolution),
    names_from = variable,
    values_from = value) %>%
  filter(!is.na(.data[[var]])) %>%
  filter(!is.na(.data[[ref]])) %>%
  mutate(value = .data[[var]] / .data[[ref]]) %>%
  select(-c(var, ref, "resolution")) %>%
  mutate(value = value * 100)


plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "region_bld",
    ncol = 4,
    y_label = "Energy poverty rate (%)",
    free_y = FALSE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_energy_poverty_threshold_countries.png"), sep = "/"),
    y_label_suffix = "%")

legend <- FALSE
presentation <- TRUE
plot_multiple_lines(filter(temp, region_bld == "EU"),
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = NULL,
    ncol = 4,
    y_label = "Energy poverty rate (%)",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_energy_poverty_threshold_eu.png"), sep = "/"),
    y_label_suffix = "%",
    legend = legend,
    presentation = presentation)

```

#### Energy poverty by income class

```{r}
temp <- data %>%
  filter(region_bld == "EU") %>%
  filter(variable == "energy_poverty_thres") %>%
  filter(resolution %in% c("q1", "q2", "q3")) %>%
  mutate(value = value / 1e6) %>%
  select(-c("variable", "region_bld"))

plot_multiple_lines(temp,
    x_column = "year",
    y_column = "value",
    line_column = "scenario",
    group_column = "resolution",
    ncol = 4,
    y_label = "Energy poverty\nMillion",
    free_y = TRUE,
    colors_lines = colors_scenarios,
    save_path = paste(save_dir,
      paste0(run, "_energy_poverty_income.png"), sep = "/"),
    y_label_suffix = "M")

```