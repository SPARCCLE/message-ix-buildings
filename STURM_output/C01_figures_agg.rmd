---
output: reprex::reprex_document
knit: reprex::reprex_render
---

Notebook to run STURM Ouput.

```{r}
library(dplyr)
library(ggplot2)
library(stringr)
library(tidyr)

print(paste("Working directory is:", getwd()))

# Loding figures setttings and functions
source("STURM_output/C00_plots.R")

```

```{r}
scenario <- "EU"
file <- paste0("report_agg_STURM_", scenario, "_resid_region_bld_energy.csv")
file <- paste("STURM_output/results", file, sep = "/")

if (!file.exists(file)) {
  print("Check file name or directory!")
}

save_dir <- paste("STURM_output", "figures", sep = "/")
print(dir.exists(save_dir))
```

```{r}
# Read output files
data <- read.csv(file)
print(summary(data))
print(unique(data$variable))
```

```{r}
# Reconstuction flows
flows <- c("cost_renovation_EUR", "n_renovation")
stp <- 5
data <- data %>%
  mutate(year = ifelse(variable %in% flows, year - stp, year),
         value = ifelse(variable %in% flows, value / stp, value))

```

## Figures 

### Indicators charts
```{r}
make_plot_lines <- function(data, var, ref, path, y_label = "") {
  temp <- data %>%
    filter(variable %in% c(var, ref)) %>%
    filter(resolution == "all") %>%
    pivot_wider(id_cols = c(region_bld, year, resolution),
      names_from = variable,
      values_from = value) %>%
    filter(!is.na(.data[[var]])) %>%
    filter(!is.na(.data[[ref]])) %>%
    mutate(value = .data[[var]] / .data[[ref]]) %>%
    select(-c(var, ref, "resolution"))

  plot_lines(temp,
            x_column = "year",
            y_column = "value",
            group_column = "region_bld",
            ncol = 4,
            y_label = y_label,
            subplot = TRUE,
            save_path = paste(save_dir, paste0(scenario, path), sep = "/"))
  }

var <- "n_renovation"
ref <- "stock_building"
path <- "_renovation_rate_countries.png"
make_plot_lines(data, var, ref, path)

var <- "heat_kWh"
ref <- "stock_building"
path <- "_kwh_dwelling_countries.png"
make_plot_lines(data, var, ref, path)

var <- "heat_kWh"
ref <- "floor_m2"
path <- "_kwh_m2_countries.png"
make_plot_lines(data, var, ref, path)
```


### Absolute values charts
#### Stock
```{r}
temp <- data %>%
  filter(variable == "stock_building") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e6)

plot_lines(temp,
          x_column = "year",
          y_column = "value",
          group_column = "region_bld",
          ncol = 4,
          y_label = "Stock housing units\nMillion",
          subplot = TRUE,
          free_y = TRUE,
          save_path = paste(save_dir, paste0(scenario, "_stock_countries.png"), sep = "/"))
```

#### Space heating consumption
```{r}
temp <- data %>%
  filter(variable == "heat_kWh") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e9)

plot_lines(temp,
          x_column = "year",
          y_column = "value",
          group_column = "region_bld",
          ncol = 4,
          y_label = "Space heating consumption\nTWh",
          subplot = TRUE,
          free_y = TRUE,
          save_path = paste(save_dir, paste0(scenario, "_twh_countries.png"), sep = "/"))

temp <- data %>%
  filter(variable == "heat_kWh") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value * 3.6 * 1e-6)

plot_lines(temp,
          x_column = "year",
          y_column = "value",
          group_column = "region_bld",
          ncol = 4,
          y_label = "Space heating consumption\nTJ",
          subplot = TRUE,
          free_y = TRUE,
          save_path = paste(save_dir, paste0(scenario, "_tj_countries.png"), sep = "/"))

temp <- data %>%
  filter(variable == "heat_kWh") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / (11630 * 1e6))

plot_lines(temp,
          x_column = "year",
          y_column = "value",
          group_column = "region_bld",
          ncol = 4,
          y_label = "Space heating consumption\nMtoe",
          subplot = TRUE,
          free_y = TRUE,
          save_path = paste(save_dir, paste0(scenario, "_mtoe_countries.png"), sep = "/"))
```

#### Number of renovations
```{r}
temp <- data %>%
  filter(variable == "n_renovation") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e3)

plot_lines(temp,
          x_column = "year",
          y_column = "value",
          group_column = "region_bld",
          ncol = 4,
          y_label = "Number of renovations\nThousands",
          subplot = TRUE,
          free_y = TRUE,
          save_path = paste(save_dir, paste0(scenario, "_renovation_countries.png"), sep = "/"))

temp <- data %>%
  filter(variable == "cost_renovation_EUR") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e9)

plot_lines(temp,
          x_column = "year",
          y_column = "value",
          group_column = "region_bld",
          ncol = 4,
          y_label = "Cost shell energy renovation\nBillion EUR",
          subplot = TRUE,
          free_y = TRUE,
          save_path = paste(save_dir, paste0(scenario, "_cost_renovation_countries.png"), sep = "/"))

temp <- data %>%
  filter(variable == "cost_heat_EUR") %>%
  filter(resolution %in% "all") %>%
  select(-c("variable", "resolution")) %>%
  mutate(value = value / 1e9)

plot_lines(temp,
          x_column = "year",
          y_column = "value",
          group_column = "region_bld",
          ncol = 4,
          y_label = "Cost heat\nBillion EUR",
          subplot = TRUE,
          free_y = TRUE,
          save_path = paste(save_dir, paste0(scenario, "_cost_heat_countries.png"), sep = "/"))

```

### Share in total stock and energy consumption
```{r}
temp <- data %>%
  filter(variable == "stock_building") %>%
  filter(resolution %in% names(rename_fuels)) %>%
  select(-c("variable"))

plot_stacked_areas(temp, "year", "value", "resolution", "region_bld",
                    y_label = "Stock housing units",
                    save_path = paste(save_dir, paste0(scenario, "_share_fuels_stock_countries.png"),
                    sep = "/"))

temp <- data %>%
  filter(variable == "stock_building") %>%
  filter(resolution %in% names(rename_eneff)) %>%
  select(-c("variable"))

plot_stacked_areas(temp, "year", "value", "resolution", "region_bld",
                    y_label = "Stock housing units",
                    save_path = paste(save_dir, paste0(scenario, "_share_eff_stock_countries.png"),
                    sep = "/"))
```

```{r}
temp <- data %>%
  filter(variable == "heat_kWh") %>%
  filter(resolution %in% names(rename_fuels)) %>%
  select(-c("variable"))

plot_stacked_areas(temp, "year", "value", "resolution", "region_bld",
                    y_label = "Space heating consumption",
                    save_path = paste(save_dir, paste0(scenario, "_share_fuels_consumption_countries.png"),
                    sep = "/"))

temp <- data %>%
  filter(variable == "heat_kWh") %>%
  filter(resolution %in% names(rename_eneff)) %>%
  select(-c("variable"))

plot_stacked_areas(temp, "year", "value", "resolution", "region_bld",
                    y_label = "Space heating consumption",
                    save_path = paste(save_dir, paste0(scenario, "_share_eff_consumption_countries.png"),
                    sep = "/"))
```